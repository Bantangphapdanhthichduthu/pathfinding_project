<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathfinding Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f0f0;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        #map {
            flex: 1;
            background: #ddd;
            position: relative;
        }
        
        .sidebar {
            width: 300px;
            background: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .sidebar-content {
            padding: 20px;
            flex: 1;
        }
        
        .control-section {
            margin-bottom: 20px;
        }
        
        .control-section h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
        }
        
        .point-display {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }
        
        .point-display strong {
            display: block;
            margin-bottom: 5px;
        }
        
        button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .result-box {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            border: 1px solid #4caf50;
            display: none;
        }
        
        .result-box.show {
            display: block;
        }
        
        .result-box h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .result-box p {
            font-size: 12px;
            color: #333;
            margin: 5px 0;
        }
        
        .path-list {
            max-height: 150px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .path-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 12px;
            display: none;
        }
        
        .status-message.show {
            display: block;
        }
        
        .status-message.info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 3px solid #1565c0;
        }
        
        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border-left: 3px solid #c62828;
        }
        
        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 3px solid #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="map"></div>
        <div class="sidebar">
            <div class="sidebar-header">‚öôÔ∏è Pathfinding</div>
            <div class="sidebar-content">
                <div class="control-section">
                    <h3>H∆∞·ªõng d·∫´n</h3>
                    <p style="font-size: 12px; color: #666; line-height: 1.6;">
                        1. Click tr√™n b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm b·∫Øt ƒë·∫ßu (ƒëi·ªÉm xanh)<br>
                        2. Click l·∫ßn n·ªØa ƒë·ªÉ ch·ªçn ƒëi·ªÉm k·∫øt th√∫c (ƒëi·ªÉm ƒë·ªè)<br>
                        3. Nh·∫•n "T√¨m ƒë∆∞·ªùng" ƒë·ªÉ t√¨m ƒë∆∞·ªùng ƒëi ng·∫Øn nh·∫•t
                    </p>
                </div>
                
                <div class="control-section">
                    <h3>ƒêi·ªÉm b·∫Øt ƒë·∫ßu</h3>
                    <div id="startPoint" class="point-display">
                        Ch∆∞a ch·ªçn
                    </div>
                </div>
                
                <div class="control-section">
                    <h3>ƒêi·ªÉm k·∫øt th√∫c</h3>
                    <div id="endPoint" class="point-display">
                        Ch∆∞a ch·ªçn
                    </div>
                </div>
                
                <button class="btn-primary" id="findPathBtn" disabled>
                    üîç T√¨m ƒë∆∞·ªùng
                </button>
                
                <button class="btn-secondary" id="resetBtn">
                    üîÑ L√†m l·∫°i
                </button>
                
                <div id="statusMsg" class="status-message"></div>
                
                <div id="resultBox" class="result-box">
                    <h4>‚úÖ K·∫øt qu·∫£</h4>
                    <p><strong>ƒê∆∞·ªùng ƒëi:</strong></p>
                    <div id="pathList" class="path-list"></div>
                    <p id="distanceText" style="margin-top: 10px;"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000/api/pathfinding';
        
        let map;
        let imageOverlay;
        let markers = { start: null, end: null };
        let selectedPath = null;
        let startCoord = null;
        let endCoord = null;
        
        // C·∫•u h√¨nh Leaflet cho pixel coordinates
        const imageWidth = 8500;
        const imageHeight = 7801;
        
        function initMap() {
            // d√πng CRS Simple c√≥ s·∫µn ƒë·ªÉ l√†m vi·ªác v·ªõi pixel coordinates
            map = L.map('map', {
                crs: L.CRS.Simple,
                maxZoom: 5,
                minZoom: -3,
                zoom: 0,
                center: [imageHeight / 2, imageWidth / 2]
            });
            
            // Load ·∫£nh b·∫£n ƒë·ªì
            const imageBounds = [[0, 0], [imageHeight, imageWidth]];
            imageOverlay = L.imageOverlay('/static/map.png', imageBounds).addTo(map);
            
            map.fitBounds(imageBounds);
            
            // S·ª± ki·ªán click tr√™n b·∫£n ƒë·ªì
            map.on('click', onMapClick);
            
            // Load nodes v√† edges t·ª´ API
            //loadNodesAndEdges();
        }
        
        function onMapClick(e) {
            const lat = e.latlng.lat; // y
            const lng = e.latlng.lng; // x
            
            if (!startCoord) {
                startCoord = { x: lng, y: lat };
                addMarker('start', startCoord);
                showStatus(`ƒêi·ªÉm b·∫Øt ƒë·∫ßu: (${Math.round(lng)}, ${Math.round(lat)})`, 'info');
            } else if (!endCoord) {
                endCoord = { x: lng, y: lat };
                addMarker('end', endCoord);
                showStatus(`ƒêi·ªÉm k·∫øt th√∫c: (${Math.round(lng)}, ${Math.round(lat)})`, 'info');
                document.getElementById('findPathBtn').disabled = false;
            }
            
            updatePointDisplay();
        }
        
        function addMarker(type, coord) {
            const icon = L.icon({
                iconUrl: getMarkerIcon(type),
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            
            const marker = L.marker([coord.y, coord.x], { icon }).addTo(map);
            
            if (markers[type]) {
                map.removeLayer(markers[type]);
            }
            markers[type] = marker;
        }
        
        function getMarkerIcon(type) {
            if (type === 'start') {
                // SVG cho ƒëi·ªÉm b·∫Øt ƒë·∫ßu (xanh)
                return 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI4IiBmaWxsPSIjNDJhNWY1IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=';
            } else {
                // SVG cho ƒëi·ªÉm k·∫øt th√∫c (ƒë·ªè)
                return 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI4IiBmaWxsPSIjZWYyNTJiIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=';
            }
        }
        
        function updatePointDisplay() {
            const startEl = document.getElementById('startPoint');
            const endEl = document.getElementById('endPoint');
            
            if (startCoord) {
                startEl.innerHTML = `<strong>üü¢ B·∫Øt ƒë·∫ßu</strong>X: ${Math.round(startCoord.x)}, Y: ${Math.round(startCoord.y)}`;
            }
            
            if (endCoord) {
                endEl.innerHTML = `<strong>üî¥ K·∫øt th√∫c</strong>X: ${Math.round(endCoord.x)}, Y: ${Math.round(endCoord.y)}`;
            }
        }
        
        async function loadNodesAndEdges() {
            try {
                const response = await fetch(`${API_URL}/nodes`);
                const nodes = await response.json();
                
                // V·∫Ω c√°c node tr√™n b·∫£n ƒë·ªì
                nodes.forEach(node => {
                    L.circleMarker([node.y, node.x], {
                        radius: 5,
                        fillColor: '#667eea',
                        color: '#fff',
                        weight: 2,
                        opacity: 0.8,
                        fillOpacity: 0.6
                    }).bindPopup(`<strong>${node.name}</strong><br/>X: ${Math.round(node.x)}, Y: ${Math.round(node.y)}`).addTo(map);
                });
            } catch (error) {
                console.error('L·ªói khi load nodes:', error);
            }
        }
        
        async function findPath() {
            if (!startCoord || !endCoord) return;
            
            document.getElementById('findPathBtn').disabled = true;
            showStatus('ƒêang t√¨m ƒë∆∞·ªùng...', 'info');
            
            try {
                const response = await fetch(`${API_URL}/find-path`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_x: startCoord.x,
                        start_y: startCoord.y,
                        end_x: endCoord.x,
                        end_y: endCoord.y
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'L·ªói khi t√¨m ƒë∆∞·ªùng');
                }
                
                displayPath(data);
                showStatus('T√¨m th·∫•y ƒë∆∞·ªùng ƒëi!', 'success');
            } catch (error) {
                showStatus(`L·ªói: ${error.message}`, 'error');
            } finally {
                document.getElementById('findPathBtn').disabled = false;
            }
        }
        
        function displayPath(data) {
            // X√≥a ƒë∆∞·ªùng c≈©
            if (selectedPath) {
                map.removeLayer(selectedPath);
            }
            
            // V·∫Ω ƒë∆∞·ªùng m·ªõi
            const latlngs = data.coordinates.map(c => [c.y, c.x]);
            selectedPath = L.polyline(latlngs, {
                color: '#ff7300',
                weight: 3,
                opacity: 0.7,
                dashArray: '5, 5'
            }).addTo(map);
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            const pathList = document.getElementById('pathList');
            pathList.innerHTML = data.path.map((node, idx) => 
                `<div class="path-item">${idx + 1}. ${node}</div>`
            ).join('');
            
            const distanceText = document.getElementById('distanceText');
            distanceText.innerHTML = `<strong>T·ªïng kho·∫£ng c√°ch:</strong> ${data.total_distance.toFixed(2)} pixels`;
            
            document.getElementById('resultBox').classList.add('show');
        }
        
        function showStatus(msg, type) {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = `status-message show ${type}`;
        }
        
        function resetMap() {
            startCoord = null;
            endCoord = null;
            if (markers.start) map.removeLayer(markers.start);
            if (markers.end) map.removeLayer(markers.end);
            if (selectedPath) map.removeLayer(selectedPath);
            markers = { start: null, end: null };
            
            document.getElementById('startPoint').innerHTML = 'Ch∆∞a ch·ªçn';
            document.getElementById('endPoint').innerHTML = 'Ch∆∞a ch·ªçn';
            document.getElementById('resultBox').classList.remove('show');
            document.getElementById('statusMsg').classList.remove('show');
            document.getElementById('findPathBtn').disabled = true;
        }
        
        document.getElementById('findPathBtn').addEventListener('click', findPath);
        document.getElementById('resetBtn').addEventListener('click', resetMap);
        
        // Kh·ªüi t·∫°o b·∫£n ƒë·ªì khi t·∫£i trang
        window.addEventListener('load', initMap);
    </script>
</body>
</html>